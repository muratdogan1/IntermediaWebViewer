@model Intermedia.Web.Models.ViewerIndexVm

<div class="ov-shell">
  <div class="ov-card">
    <div class="ov-topbar">
      <div>
        <span class="ov-brand">interMEDIA</span>
        <span class="ov-sub">interMEDIA Dicom viewer</span>
      </div>
      <div class="ov-tabs">
        <a class="ov-tab" asp-controller="Studies" asp-action="Index">Home</a>
        <a class="ov-tab active" asp-controller="Viewer" asp-action="Index">Viewer</a>
      </div>
    </div>

    <div class="ov-content">
      <div class="viewer-grid">

        <!-- LEFT -->
        <div class="viewer-left">
          <div class="study-tree" id="studyTree">
            @if (Model.Studies.Count == 0)
            {
              <div style="color:#aaa;padding:12px">Storage içinde görüntü (.dcm + PixelData) yok.</div>
            }
            else
            {
              foreach (var st in Model.Studies)
              {
                <div class="study-block">
                  <div class="study-title">
                    <div class="study-pn">@(!string.IsNullOrWhiteSpace(st.PatientName) ? st.PatientName : "Patient")</div>
                    <div class="study-uid" title="@st.StudyInstanceUid">@st.StudyInstanceUid</div>
                    @if (!string.IsNullOrWhiteSpace(st.StudyDate))
                    {
                      <div class="study-date">@st.StudyDate</div>
                    }
                  </div>

                  @foreach (var se in st.Series
                    .Where(x =>
                      !string.Equals((x.SeriesDescription ?? "").Trim(), "AutoAlign Verification", StringComparison.OrdinalIgnoreCase) &&
                      !string.Equals((x.SeriesDescription ?? "").Trim(), "PhoenixZIPReport", StringComparison.OrdinalIgnoreCase)
                    ))
                  {
                    <div class="series-block">
                      <div class="series-title">
                        <span class="badge">@(!string.IsNullOrWhiteSpace(se.Modality) ? se.Modality : "OT")</span>
                        <span class="series-desc">@(!string.IsNullOrWhiteSpace(se.SeriesDescription) ? se.SeriesDescription : "Series")</span>
                        <span class="series-uid" title="@se.SeriesInstanceUid">@se.SeriesInstanceUid</span>
                      </div>

                      <div class="gridthumbs">
                        @foreach (var f in se.Files)
                        {
                          var active = string.Equals(f.FileName, Model.Selected, StringComparison.OrdinalIgnoreCase) ? "active" : "";
                          <a class="thumbLink @active"
                             data-file="@f.FileName"
                             asp-controller="Viewer"
                             asp-action="Index"
                             asp-route-file="@f.FileName">
                            <img src="@Url.Action("Render","Viewer", new { file = f.FileName, w = 160 })" />
                            <div class="thumb-meta">
                              @if (f.InstanceNumber.HasValue)
                              {
                                <span>#@f.InstanceNumber</span>
                              }
                            </div>
                          </a>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            }
          </div>
        </div>

        <!-- MAIN -->
        <div class="viewer-main">
          <div class="viewer-toolbar">

            <!-- OViyam-like icon strip -->
            <div class="ov-toolstrip">
              <button class="ov-icbtn" type="button" title="Pan (Drag)" id="toolPan">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M8 12V7a2 2 0 1 1 4 0v5h1V6a2 2 0 1 1 4 0v8.5l.7.2A3.5 3.5 0 0 1 20 18v1.5A3.5 3.5 0 0 1 16.5 23H12a6 6 0 0 1-6-6v-5a2 2 0 1 1 2 0z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="Zoom In" id="toolZoomIn">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M10.5 3a7.5 7.5 0 1 1 0 15 7.5 7.5 0 0 1 0-15zm0 2a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11z"/>
                  <path d="M10.5 8a1 1 0 0 1 1 1v1.5H13a1 1 0 1 1 0 2h-1.5V14a1 1 0 1 1-2 0v-1.5H8a1 1 0 1 1 0-2h1.5V9a1 1 0 0 1 1-1z"/>
                  <path d="M16.8 16.8a1 1 0 0 1 1.4 0l2.6 2.6a1 1 0 0 1-1.4 1.4l-2.6-2.6a1 1 0 0 1 0-1.4z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="Zoom Out" id="toolZoomOut">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M10.5 3a7.5 7.5 0 1 1 0 15 7.5 7.5 0 0 1 0-15zm0 2a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11z"/>
                  <path d="M8 11.5a1 1 0 0 1 1-1h3a1 1 0 1 1 0 2H9a1 1 0 0 1-1-1z"/>
                  <path d="M16.8 16.8a1 1 0 0 1 1.4 0l2.6 2.6a1 1 0 0 1-1.4 1.4l-2.6-2.6a1 1 0 0 1 0-1.4z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="Fit" id="toolFit">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M7 3H3v4a1 1 0 1 0 2 0V5h2a1 1 0 1 0 0-2zM21 7V3h-4a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0zM7 21H3v-4a1 1 0 1 1 2 0v2h2a1 1 0 1 1 0 2zM21 17v4h-4a1 1 0 1 1 0-2h2v-2a1 1 0 1 1 2 0z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="Reset" id="toolReset2">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5a7 7 0 1 1-6.3 4 1 1 0 1 1 1.8.9A5 5 0 1 0 12 7h-1a1 1 0 1 1 0-2h3.5A1.5 1.5 0 0 1 16 6.5V10a1 1 0 1 1-2 0V7.6A7 7 0 0 0 12 5z"/>
                </svg>
              </button>

              <span class="ov-sep"></span>

              <button class="ov-icbtn" type="button" title="Rotate Left" id="toolRotL">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5a7 7 0 1 1-6.2 10.2 1 1 0 1 1 1.8-.9A5 5 0 1 0 12 7h-1.2l1.1 1.1a1 1 0 0 1-1.4 1.4L7.7 6.7a1 1 0 0 1 0-1.4l2.8-2.8a1 1 0 1 1 1.4 1.4L10.8 5H12z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="Rotate Right" id="toolRotR">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5a7 7 0 1 0 6.2 10.2 1 1 0 1 0-1.8-.9A5 5 0 1 1 12 7h1.2l-1.1 1.1a1 1 0 0 0 1.4 1.4l2.8-2.8a1 1 0 0 0 0-1.4l-2.8-2.8a1 1 0 1 0-1.4 1.4L13.2 5H12z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="Flip H" id="toolFlipH">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M11 4a1 1 0 0 1 1 1v14a1 1 0 1 1-2 0V5a1 1 0 0 1 1-1z"/>
                  <path d="M4 12l4-4v3h4v2H8v3l-4-4zM20 12l-4 4v-3h-4v-2h4V8l4 4z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="Flip V" id="toolFlipV">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M4 11a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H5a1 1 0 0 1-1-1z"/>
                  <path d="M12 4l4 4h-3v4h-2V8H8l4-4zM12 20l-4-4h3v-4h2v4h3l-4 4z"/>
                </svg>
              </button>

              <span class="ov-sep"></span>

              <button class="ov-icbtn" type="button" title="WL/WW (Drag)" id="toolWL">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 3a9 9 0 1 0 0 18 9 9 0 0 0 0-18zm-1 3h2v12h-2V6z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="Invert" id="toolInvert">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 2a10 10 0 1 0 0 20V2zm0 2v16a8 8 0 0 1 0-16z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="1:1" id="toolOneToOne">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M7 7h3v2H9v8H7V9H6V7h1zm7 0h4v2h-2v6h2v2h-4v-2h2V9h-2V7z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="Ruler" id="toolRuler">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M3 17l9-9 4 4-9 9H3v-4zm3 2h1.6l8-8L14 9.4l-8 8V19z"/>
                </svg>
              </button>

              <button class="ov-icbtn" type="button" title="Clear Measure" id="toolClearMeasure">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M6 6l12 12-1.4 1.4L4.6 7.4 6 6zm3-2h6a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3zm0 2a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H9z"/>
                </svg>
              </button>
            </div>

            <!-- legacy reset button used by scripts -->
            <button class="tool" type="button" id="btnReset">Reset</button>

            <!-- Cine -->
            <div class="cine">
              <span>Loop</span>
              <input id="cineLoop" type="checkbox" />
              <input id="cineSlider" type="range" min="0" max="0" value="0" step="1" />
              <span id="cineInfo">0 / 0</span>
            </div>

            <span style="color:#666;font-size:12px;margin-left:12px">Wheel: Zoom • Drag: Pan</span>
          </div>

          <div class="viewer-canvas" id="canvas">
            @if (!string.IsNullOrWhiteSpace(Model.Selected))
            {
              <img id="dicomImg" draggable="false"
                   src="@Url.Action("Render","Viewer", new { file = Model.Selected })" />
            }
            else
            {
              <div style="color:#aaa">Seçili görüntü yok</div>
            }

            <canvas id="rulerOverlay"></canvas>
            <div id="wlHint" class="wl-hint" style="display:none;"></div>
          </div>

          <div class="viewer-caption" id="caption">
            Açılıyor: @Model.Selected
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  // =========================
  // PAN + ZOOM  (Wheel zoom + drag pan)
  // =========================
  (function () {
    const canvas = document.getElementById('canvas');
    const img = document.getElementById('dicomImg');
    const btnReset = document.getElementById('btnReset');
    if (!canvas || !img) return;

    let scale = 1;
    let tx = 0, ty = 0;

    let isDown = false;
    let startX = 0, startY = 0;
    let startTx = 0, startTy = 0;

    function apply() {
      img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
      img.style.transformOrigin = '0 0';
    }

    function clampScale(v) {
      return Math.min(8, Math.max(0.2, v));
    }

    function zoomAt(delta, clientX, clientY) {
      const rect = canvas.getBoundingClientRect();
      const cx = clientX - rect.left;
      const cy = clientY - rect.top;

      const prev = scale;
      const next = clampScale(scale * (delta > 0 ? 0.9 : 1.1));
      if (next === prev) return;

      const wx = (cx - tx) / prev;
      const wy = (cy - ty) / prev;

      scale = next;
      tx = cx - wx * scale;
      ty = cy - wy * scale;
      apply();
    }

    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      zoomAt(e.deltaY, e.clientX, e.clientY);
    }, { passive: false });

    canvas.addEventListener('mousedown', (e) => {
      isDown = true;
      canvas.classList.add('grabbing');
      startX = e.clientX;
      startY = e.clientY;
      startTx = tx;
      startTy = ty;
    });

    window.addEventListener('mousemove', (e) => {
      if (!isDown) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      tx = startTx + dx;
      ty = startTy + dy;
      apply();
    });

    window.addEventListener('mouseup', () => {
      isDown = false;
      canvas.classList.remove('grabbing');
    });

    btnReset?.addEventListener('click', () => {
      scale = 1;
      tx = 0; ty = 0;
      apply();
    });

    apply();
  })();

  // =========================
  // CINE SLIDER
  // =========================
  (function () {
    const slider = document.getElementById('cineSlider');
    const info = document.getElementById('cineInfo');
    const loopChk = document.getElementById('cineLoop');
    const img = document.getElementById('dicomImg');
    const caption = document.getElementById('caption');

    const thumbs = Array.from(document.querySelectorAll('a.thumbLink[data-file]'));
    if (!slider || !info || !loopChk || !img || thumbs.length === 0) {
      if (info) info.textContent = "0 / 0";
      return;
    }

    const files = thumbs.map(a => a.getAttribute('data-file'));
    const selectedFromServer = "@(Model.Selected ?? "")";

    function findIndexByFile(file) {
      if (!file) return 0;
      const ix = files.findIndex(x => (x || "").toLowerCase() === file.toLowerCase());
      return ix >= 0 ? ix : 0;
    }

    let idx = findIndexByFile(selectedFromServer);

    slider.min = 0;
    slider.max = Math.max(0, files.length - 1);
    slider.value = idx;

    function setActiveThumb(i) {
      thumbs.forEach((a, k) => {
        if (k === i) a.classList.add('active');
        else a.classList.remove('active');
      });
      thumbs[i]?.scrollIntoView({ block: 'nearest', inline: 'nearest' });
    }

    function setImageByIndex(i, updateUrl = true) {
      i = Math.max(0, Math.min(files.length - 1, i));
      idx = i;
      slider.value = i;
      info.textContent = `${i + 1} / ${files.length}`;

      const file = files[i];
      img.src = `/Viewer/Render?file=${encodeURIComponent(file)}`;
      if (caption) caption.textContent = `Açılıyor: ${file}`;

      setActiveThumb(i);

      if (updateUrl) {
        const newUrl = `/Viewer?file=${encodeURIComponent(file)}`;
        history.replaceState(null, "", newUrl);
      }
    }

    slider.addEventListener('input', () => {
      setImageByIndex(parseInt(slider.value, 10), true);
    });

    thumbs.forEach((a, i) => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        setImageByIndex(i, true);
      });
    });

    let timer = null;
    function stopLoop() {
      if (timer) { clearInterval(timer); timer = null; }
    }
    function startLoop() {
      stopLoop();
      timer = setInterval(() => {
        let next = idx + 1;
        if (next >= files.length) {
          if (loopChk.checked) next = 0;
          else { stopLoop(); return; }
        }
        setImageByIndex(next, true);
      }, 140);
    }

    loopChk.addEventListener('change', () => {
      if (loopChk.checked) startLoop();
      else stopLoop();
    });

    setImageByIndex(idx, false);
  })();

  // =========================
  // TOP TOOLBAR ACTIONS (rotate/flip + zoom buttons + fit/reset)
  // =========================
  (function () {
    const img = document.getElementById('dicomImg');
    const canvas = document.getElementById('canvas');
    if (!img || !canvas) return;

    let rot = 0; // deg
    let flipH = 1;
    let flipV = 1;

    let wrap = document.getElementById('imgWrap');
    if (!wrap) {
      wrap = document.createElement('div');
      wrap.id = 'imgWrap';
      wrap.style.display = 'inline-block';
      wrap.style.willChange = 'transform';
      img.parentNode.insertBefore(wrap, img);
      wrap.appendChild(img);
    }

    function applyExtra() {
      wrap.style.transformOrigin = 'center center';
      wrap.style.transform = `rotate(${rot}deg) scale(${flipH}, ${flipV})`;
    }

    function setActive(btn) {
      document.querySelectorAll('.ov-icbtn').forEach(x => x.classList.remove('active'));
      if (btn) btn.classList.add('active');
    }

    function fireWheelZoom(isOut) {
      const rect = canvas.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      const evt = new WheelEvent('wheel', { deltaY: isOut ? 100 : -100, clientX: cx, clientY: cy });
      canvas.dispatchEvent(evt);
    }

    document.getElementById('toolZoomIn')?.addEventListener('click', () => fireWheelZoom(false));
    document.getElementById('toolZoomOut')?.addEventListener('click', () => fireWheelZoom(true));

    const btnReset = document.getElementById('btnReset');
    document.getElementById('toolReset2')?.addEventListener('click', () => btnReset?.click());
    document.getElementById('toolFit')?.addEventListener('click', () => btnReset?.click());

    document.getElementById('toolRotL')?.addEventListener('click', () => { rot = (rot - 90) % 360; applyExtra(); });
    document.getElementById('toolRotR')?.addEventListener('click', () => { rot = (rot + 90) % 360; applyExtra(); });
    document.getElementById('toolFlipH')?.addEventListener('click', () => { flipH *= -1; applyExtra(); });
    document.getElementById('toolFlipV')?.addEventListener('click', () => { flipV *= -1; applyExtra(); });

    document.getElementById('toolPan')?.addEventListener('click', (e) => setActive(e.currentTarget));

    applyExtra();
  })();

  /* =========================
     WL / INVERT / 1:1 / RULER
     ========================= */
  (function () {
    const canvas = document.getElementById('canvas');
    const img = document.getElementById('dicomImg');
    const overlay = document.getElementById('rulerOverlay');
    const wlHint = document.getElementById('wlHint');

    if (!canvas || !img) return;

    let toolMode = 'pan'; // pan | wl | ruler
    let invertOn = false;

    let wlBrightness = 1.0; // 0.3..2.5
    let wlContrast = 1.0;   // 0.3..3.0

    let p1 = null;
    let p2 = null;

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function applyFilter() {
      const inv = invertOn ? 'invert(1) ' : '';
      img.style.filter = `${inv}brightness(${wlBrightness}) contrast(${wlContrast})`;
    }

    function setTool(mode) {
      toolMode = mode;

      // sadece bizim araçlarda active yönetelim (pan/zoom/rotate vb etkilenmesin)
      document.getElementById('toolWL')?.classList.toggle('active', mode === 'wl');
      document.getElementById('toolRuler')?.classList.toggle('active', mode === 'ruler');

      if (wlHint) {
        wlHint.style.display = (mode === 'wl') ? 'block' : 'none';
        wlHint.textContent = (mode === 'wl') ? `WL: B ${wlBrightness.toFixed(2)} • C ${wlContrast.toFixed(2)}` : '';
      }
    }

    // WL veya ruler aktifken, pan scriptinin mousedown'ını engelle
    canvas.addEventListener('mousedown', (e) => {
      if (toolMode === 'wl' || toolMode === 'ruler') {
        e.stopPropagation();
      }
    }, true);

    // ---- WL drag
    let wlDown = false;
    let wlStartX = 0, wlStartY = 0;
    let wlStartB = 1.0, wlStartC = 1.0;

    canvas.addEventListener('mousedown', (e) => {
      if (toolMode !== 'wl') return;
      wlDown = true;
      wlStartX = e.clientX;
      wlStartY = e.clientY;
      wlStartB = wlBrightness;
      wlStartC = wlContrast;
      canvas.classList.add('grabbing');
    });

    window.addEventListener('mousemove', (e) => {
      if (!wlDown) return;
      const dx = e.clientX - wlStartX;
      const dy = e.clientY - wlStartY;

      wlContrast = clamp(wlStartC + dx / 300, 0.3, 3.0);
      wlBrightness = clamp(wlStartB - dy / 300, 0.3, 2.5);
      applyFilter();

      if (wlHint) wlHint.textContent = `WL: B ${wlBrightness.toFixed(2)} • C ${wlContrast.toFixed(2)}`;
    });

    window.addEventListener('mouseup', () => {
      wlDown = false;
      canvas.classList.remove('grabbing');
    });

    // ---- RULER
    function resizeOverlay() {
      if (!overlay) return;
      const r = canvas.getBoundingClientRect();
      overlay.width = Math.floor(r.width);
      overlay.height = Math.floor(r.height);
      overlay.style.width = r.width + 'px';
      overlay.style.height = r.height + 'px';
    }

    function clearRuler() {
      p1 = null; p2 = null;
      if (!overlay) return;
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0, 0, overlay.width, overlay.height);
    }

    function drawRuler() {
      if (!overlay) return;
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0, 0, overlay.width, overlay.height);

      if (!p1 || !p2) return;

      ctx.lineWidth = 2;
      ctx.strokeStyle = 'rgba(255,138,0,0.95)';
      ctx.fillStyle = 'rgba(255,138,0,0.95)';
      ctx.beginPath();
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.stroke();

      ctx.beginPath(); ctx.arc(p1.x, p1.y, 4, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(p2.x, p2.y, 4, 0, Math.PI * 2); ctx.fill();

      const dx = p2.x - p1.x;
      const dy = p2.y - p1.y;
      const dist = Math.sqrt(dx * dx + dy * dy);

      const tx = (p1.x + p2.x) / 2;
      const ty = (p1.y + p2.y) / 2;

      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      const label = `${dist.toFixed(1)} px`;
      const w = ctx.measureText(label).width;

      ctx.fillStyle = 'rgba(0,0,0,0.65)';
      ctx.fillRect(tx - w / 2 - 6, ty - 18, w + 12, 18);

      ctx.fillStyle = 'rgba(255,255,255,0.95)';
      ctx.fillText(label, tx - w / 2, ty - 5);
    }

    canvas.addEventListener('click', (e) => {
      if (toolMode !== 'ruler') return;
      const r = canvas.getBoundingClientRect();
      const x = e.clientX - r.left;
      const y = e.clientY - r.top;

      if (!p1) { p1 = { x, y }; p2 = null; }
      else { p2 = { x, y }; }

      drawRuler();
    });

    window.addEventListener('resize', () => {
      resizeOverlay();
      drawRuler();
    });

    // ---- Buttons
    document.getElementById('toolWL')?.addEventListener('click', () => setTool(toolMode === 'wl' ? 'pan' : 'wl'));
    document.getElementById('toolRuler')?.addEventListener('click', () => {
      setTool(toolMode === 'ruler' ? 'pan' : 'ruler');
      resizeOverlay();
      drawRuler();
    });
    document.getElementById('toolClearMeasure')?.addEventListener('click', clearRuler);

    document.getElementById('toolInvert')?.addEventListener('click', () => {
      invertOn = !invertOn;
      applyFilter();
      document.getElementById('toolInvert')?.classList.toggle('active', invertOn);
    });

    document.getElementById('toolOneToOne')?.addEventListener('click', () => {
      // 1:1 => zoom/pan reset + WL reset + invert kapat
      document.getElementById('btnReset')?.click();
      wlBrightness = 1.0;
      wlContrast = 1.0;
      invertOn = false;
      applyFilter();
      document.getElementById('toolInvert')?.classList.remove('active');
      if (wlHint && toolMode === 'wl') wlHint.textContent = `WL: B ${wlBrightness.toFixed(2)} • C ${wlContrast.toFixed(2)}`;
    });

    // init
    applyFilter();
    resizeOverlay();
    setTool('pan');
  })();
</script>